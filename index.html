<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pao Form</title>
  <style>
    .error-message {
      color: red;
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <form id="myForm">
    <label for="personalName">Personal Name:</label>
    <input type="text" id="personalName" name="personalName">
    <div id="personalNameError" class="error-message"></div>

    <label for="personalEmail">Personal Email:</label>
    <input type="email" id="personalEmail" name="personalEmail">
    <div id="personalEmailError" class="error-message"></div>

    <div id="address">
      <label for="city">City:</label>
      <input type="text" id="city" name="city">
      <div id="cityError" class="error-message"></div>

      <label for="zipcode">Zipcode:</label>
      <input type="text" id="zipcode" name="zipcode">
      <div id="zipcodeError" class="error-message"></div>

      <label for="country">Country:</label>
      <select id="country" name="country">
        <option value="us">United States</option>
        <option value="ca">Canada</option>
        <option value="uk">United Kingdom</option>
      </select>
      <div id="countryError" class="error-message"></div>
    </div>

    <div id="emails">
      <label>Emails:</label>
      <div id="emailsArrayError" class="error-message"></div>
      <div id="emailsArray">
        <!-- FormArray for emails with multiple controls -->
      </div>
      <button type="button" id="addEmail">Add Email</button>
    </div>

      <button type="button" id="tsubscriber">Trigger Subscriber</button>
    <button type="submit">Submit</button>
  </form>

  <script type="module">
      import { FormGroup, FormControl, FormArray } from './src/pao-form'
      const Validators = {
        required: {
          validator: (value) => !!value,
          errorMessage: 'This field is required.',
        },
        email: {
          validator: (value) => /\S+@\S+\.\S+/.test(value),
          errorMessage: 'Invalid email address.',
        },
        validCountry: {
          validator: (value) => value == 'us',
          errorMessage: 'Invalid country!'
        }
      };

      const form = new FormGroup();

      form.addControl('personalName', '', [Validators.required]);
      form.addControl('personalEmail', '', [Validators.required, Validators.email]);

      const addressGroup = new FormGroup();
      addressGroup.addControl('city', '', [Validators.required]);
      addressGroup.addControl('zipcode', '', [Validators.required]);
      addressGroup.addControl('country', 'us', [Validators.required, Validators.validCountry]);

      form.addGroup('address', addressGroup);

      // FormArray for emails with multiple controls
      const emailsArray = new FormArray();
      form.addFormArray('emails', emailsArray);

      const emailFormGroup = new FormGroup();

      document.getElementById('addEmail').addEventListener('click', () => {

        const emailInput = document.createElement('input');
        let uniqId = `email${emailsArray.controls.length}`;
        emailInput.type = 'email';
        emailInput.id = uniqId;
        emailInput.name = uniqId;
        emailInput.placeholder = 'Enter email';
        document.getElementById('emailsArray').appendChild(emailInput);

        const emailInputError = document.createElement('div');
        emailInputError.id = `${uniqId}Error`;
        emailInputError.className = 'error-message';
        document.getElementById('emailsArray').appendChild(emailInputError);

        // of course document should b ready first
        emailFormGroup.addControl(uniqId, '', [Validators.required, Validators.email]);

        emailsArray.push(emailFormGroup);

        // trigger validation
        form.validateAll();
        
        console.log(form.controls.emails.controls)
        console.log(form)
        console.log(emailsArray.value)

      });
      document.getElementById('addEmail').click();
      document.getElementById('addEmail').click();



      function submitForm(event) {
        event.preventDefault();
        form.validateAll();


        if (form.valid) {
          const formData = form.value;
          console.log('Form Data:', formData);
        } else {
          console.log('Form is not valid. Please correct the errors.');
        }
      }

      const formElement = document.getElementById('myForm');
      formElement.addEventListener('submit', submitForm);

      // Trigger validation on initial load for all form fields
      form.validateAll();

      //// set value
      //form.setValue('personalName', 'John Doe'); // value setter
      //form.setValue('personalEmail', 'abc@com'); // value setter


      /// display value
      console.log(form.controls.personalEmail.value)


      // Subscribe to value changes specific control
      //form.controls.personalEmail.subscribe(value => {
      //  console.log('Value changed:', value);
      //});

      // Subscribe to value changes 
      form.subscribe('personalEmail', value => {
        console.log('Value changed personal email:', value);
      });

      // Subscribe to value changes for nested group control?
      addressGroup.subscribe('city', value => {
        console.log('Value changed of address group city:', value);
      });

      addressGroup.subscribe('country', value => {
        console.log('Value changed of address group country:', value);
      });


      console.log(form)

      // Subscribe to value changes for array
      // emailFormGroup is assigned to an array
      //emailFormGroup.subscribe(value => {
      //  console.log('Value changed of array > emailFormGroup:', value);
      //})


      document.getElementById('tsubscriber').addEventListener('click', () => {
        // Update the value, triggering the subscription  . it will only trigger if defined using form.subscribe
        form.setValue('personalEmail', new Date()); // value setter

        // Subscribe to value changes for nested group control?
        // addressGroup.subscribe('city', value => {
        addressGroup.setValue('city', new Date());
        addressGroup.setValue('country', 'ca');

      // Subscribe to value changes for array
      // emailFormGroup is assigned to an array
      //emailsArray.setValue(['ab', 'hhy'])


      })
  </script>

</body>
</html>
